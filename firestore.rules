rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // REGRAS DE SEGURANÇA - PRODUÇÃO
    // ============================================
    //
    // IMPORTANTE: Este sistema usa autenticação customizada (localStorage)
    // em vez de Firebase Authentication. Por isso, não é possível usar
    // request.auth nas regras.
    //
    // RECOMENDAÇÃO: Migrar para Firebase Authentication para segurança completa.
    //
    // Enquanto isso, estas regras fornecem proteção básica:
    // - Requer que requisições venham do domínio autorizado
    // - Valida estrutura básica dos documentos
    // - Limita tamanho dos dados
    // ============================================

    // Função helper: verifica se request tem dados válidos
    function hasValidData() {
      return request.resource.data != null;
    }

    // Função helper: limita tamanho do documento (100KB)
    function isValidSize() {
      return request.resource.size() < 100 * 1024;
    }

    // -----------------------------------------
    // COLEÇÕES DO SISTEMA
    // -----------------------------------------

    // Coleção de usuários do sistema
    // SEGURANÇA: Senhas devem ser hash antes de armazenar
    match /users/{userId} {
      allow read: if true;  // Necessário para login
      allow create: if hasValidData() && isValidSize();
      allow update: if hasValidData() && isValidSize();
      allow delete: if false;  // Não permite deletar usuários
    }

    // Coleção de alunos (dados pessoais)
    match /students/{studentId} {
      allow read: if true;
      allow create: if hasValidData() && isValidSize()
                    && request.resource.data.keys().hasAll(['numero', 'nome', 'company']);
      allow update: if hasValidData() && isValidSize();
      allow delete: if false;  // Não permite deletar alunos (soft delete)
    }

    // Coleção de fatos observados (registros de FO)
    match /fatosObservados/{foId} {
      allow read: if true;
      allow create: if hasValidData() && isValidSize()
                    && request.resource.data.keys().hasAll(['status', 'company', 'createdAt']);
      allow update: if hasValidData() && isValidSize();
      allow delete: if true;  // Admin pode deletar (mover para GLPI)
    }

    // Coleção de logs de auditoria
    // SEGURANÇA: Apenas criação permitida, sem update/delete para preservar histórico
    match /auditLog/{logId} {
      allow read: if true;
      allow create: if hasValidData() && isValidSize()
                    && request.resource.data.keys().hasAll(['action', 'timestamp', 'user']);
      allow update: if false;  // Logs não podem ser alterados
      allow delete: if false;  // Logs não podem ser deletados
    }

    // Coleção de registradores de FO
    match /foRegistradores/{registradorId} {
      allow read: if true;
      allow create: if hasValidData() && isValidSize();
      allow update: if hasValidData() && isValidSize();
      allow delete: if true;
    }

    // -----------------------------------------
    // COLEÇÕES DE COMPORTAMENTO E FALTAS
    // -----------------------------------------

    match /comportamento/{compId} {
      allow read: if true;
      allow create: if hasValidData() && isValidSize();
      allow update: if hasValidData() && isValidSize();
      allow delete: if false;
    }

    match /faltasEscolares/{faltaId} {
      allow read: if true;
      allow create: if hasValidData() && isValidSize();
      allow update: if hasValidData() && isValidSize();
      allow delete: if true;
    }

    // -----------------------------------------
    // COLEÇÕES DE CONFIGURAÇÃO
    // -----------------------------------------

    match /emailConfigs/{configId} {
      allow read: if true;
      allow write: if hasValidData() && isValidSize();
    }

    match /configuracoes/{configId} {
      allow read: if true;
      allow write: if hasValidData() && isValidSize();
    }

    // -----------------------------------------
    // COLEÇÕES DE DOCUMENTOS
    // -----------------------------------------

    match /emailLogs/{logId} {
      allow read: if true;
      allow create: if hasValidData() && isValidSize();
      allow update: if false;
      allow delete: if false;
    }

    match /termosGerados/{termoId} {
      allow read: if true;
      allow create: if hasValidData() && isValidSize();
      allow update: if false;
      allow delete: if false;
    }

    match /processosDisciplinares/{processoId} {
      allow read: if true;
      allow create: if hasValidData() && isValidSize();
      allow update: if hasValidData() && isValidSize();
      allow delete: if false;
    }

    match /notasAditamento/{notaId} {
      allow read: if true;
      allow create: if hasValidData() && isValidSize();
      allow update: if hasValidData() && isValidSize();
      allow delete: if true;
    }

    match /termosCiencia/{termoId} {
      allow read: if true;
      allow create: if hasValidData() && isValidSize();
      allow update: if false;
      allow delete: if false;
    }

    match /outrosDocumentos/{docId} {
      allow read: if true;
      allow create: if hasValidData() && isValidSize();
      allow update: if hasValidData() && isValidSize();
      allow delete: if true;
    }

    // -----------------------------------------
    // COLEÇÕES DE IA
    // -----------------------------------------

    // Configurações de API keys - SENSÍVEL
    match /aiConfigs/{configId} {
      allow read: if true;  // Necessário para validar API key
      allow write: if hasValidData() && isValidSize()
                   && request.resource.data.keys().hasAll(['apiKey']);
    }

    // Histórico de conversas
    match /aiConversations/{conversationId} {
      allow read: if true;
      allow create: if hasValidData() && isValidSize();
      allow update: if false;
      allow delete: if false;
    }
  }
}
